import React, { useState, useEffect, useRef } from 'react';
import { useTranslation } from 'react-i18next';
import { Search } from 'lucide-react';
import { useNavigate, useParams, Route, Routes, Link, useLocation } from 'react-router-dom';
import { api, apiBaseUrl, useMock as isMockMode } from './services/api';
import { Board, Thread } from './types';
import { PostForm } from './components/PostForm';
import { ThreadView } from './components/ThreadDetail';
import { Button } from './components/ui/button';
import { DonateModal } from './components/DonateModal';
import { Pagination } from './components/Pagination';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"
import { Docs } from './pages/Docs';
import { PrivacyPolicy } from './pages/PrivacyPolicy';
import { Terms } from './pages/Terms';
import { Help } from './pages/Help';
import { QA } from './pages/QA';
import { Changelog } from './pages/Changelog';

// åº”ç”¨å…¥å£ï¼šè·¯ç”±ã€å…¨å±€çŠ¶æ€ã€SSE é€šçŸ¥ã€ä»¥åŠä¸»è¦å¸ƒå±€ã€‚
// App entry: routing, global state, SSE notices, and overall layout.

// --- Board View Component ---
// çœ‹æ¿åˆ—è¡¨é¡µï¼šè´Ÿè´£åˆ†é¡µã€æœç´¢è¿‡æ»¤ã€ç§»åŠ¨ç«¯æ— é™æ»šåŠ¨ã€‚
// Board view: handles pagination, search filtering, and mobile infinite scroll.
const BoardView: React.FC<{
  boards: Board[];
  search: string;
  onCreateThread: (payload: any) => void;
  onThreadClick: (thread: Thread) => void;
  onToggleHide: (e: React.MouseEvent, id: string) => void;
  onToggleFollow: (e: React.MouseEvent, id: string) => void;
  hiddenThreads: Set<string>;
  followedThreads: Set<string>;
  refreshToken: number;
}> = ({ boards, search, onCreateThread, onThreadClick, onToggleHide, onToggleFollow, hiddenThreads, followedThreads, refreshToken }) => {
  const { t, i18n } = useTranslation();
  const { boardId } = useParams();
  const [threads, setThreads] = useState<Thread[]>([]);
  const [showPostForm, setShowPostForm] = useState(false);

  // åˆ†é¡µçŠ¶æ€ï¼ˆPC æ¨¡å¼ä½¿ç”¨åˆ†é¡µï¼Œç§»åŠ¨ç«¯ä½¿ç”¨æ— é™æ»šåŠ¨ï¼‰ã€‚
  // Pagination state (desktop paging, mobile infinite scroll).
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(false);
  const [hasMore, setHasMore] = useState(true);

  // è®¾å¤‡åˆ¤å®šï¼šå®½åº¦ < 768 è§†ä¸ºç§»åŠ¨ç«¯ã€‚
  // Device detection: width < 768 treated as mobile.
  const [isMobile, setIsMobile] = useState(false);

  // æ— é™æ»šåŠ¨æ‰€éœ€çš„ observer ä¸è§¦å‘å…ƒç´ ã€‚
  // IntersectionObserver + sentinel for infinite scroll.
  const loadMoreRef = React.useRef<HTMLDivElement>(null);
  const observerRef = React.useRef<IntersectionObserver | null>(null);

  // åˆå§‹åŒ–/çª—å£å˜åŒ–æ—¶æ£€æµ‹è®¾å¤‡ã€‚
  // Detect device on mount and resize.
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // æ‹‰å–çº¿ç¨‹åˆ—è¡¨ï¼šæ”¯æŒè¦†ç›–æˆ–è¿½åŠ ã€‚
  // Fetch threads: replace or append.
  const loadThreads = async (page: number, append: boolean = false) => {
    if (loading || !boardId) return;
    setLoading(true);

    try {
      const data = await api.getThreads(boardId, page);
      if (append) {
        setThreads(prev => [...prev, ...data.threads]);
      } else {
        setThreads(data.threads);
      }
      setTotal(data.total);
      setTotalPages(data.totalPages);
      setHasMore(page < data.totalPages);
    } catch (error) {
      console.error('Failed to load threads:', error);
    } finally {
      setLoading(false);
    }
  };

  // é¦–æ¬¡è¿›å…¥æˆ–æ¿å—åˆ‡æ¢æ—¶é‡æ–°åŠ è½½ã€‚
  // Reload on first mount or board switch.
  useEffect(() => {
    if (boardId) {
      setThreads([]);
      setCurrentPage(1);
      setHasMore(true);
      loadThreads(1, false);
    }
    setShowPostForm(false);
  }, [boardId]);

  useEffect(() => {
    if (!boardId || refreshToken === 0) return;
    setThreads([]);
    setCurrentPage(1);
    setHasMore(true);
    loadThreads(1, false);
  }, [refreshToken, boardId]);

  // PC æ¨¡å¼åˆ†é¡µåˆ‡æ¢ã€‚
  // Desktop pagination handler.
  const handlePageChange = (page: number) => {
    setCurrentPage(page);
    loadThreads(page, false);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // ç§»åŠ¨ç«¯ï¼šè§‚å¯Ÿè§¦åº•å¹¶è¿½åŠ ä¸‹ä¸€é¡µã€‚
  // Mobile: observe sentinel and append next page.
  useEffect(() => {
    if (!isMobile || !hasMore || loading) return;

    if (observerRef.current) observerRef.current.disconnect();

    observerRef.current = new IntersectionObserver(
      entries => {
        if (entries[0].isIntersecting && hasMore && !loading) {
          const nextPage = currentPage + 1;
          setCurrentPage(nextPage);
          loadThreads(nextPage, true);
        }
      },
      { threshold: 0.1 }
    );

    if (loadMoreRef.current) {
      observerRef.current.observe(loadMoreRef.current);
    }

    return () => {
      if (observerRef.current) {
        observerRef.current.disconnect();
      }
    };
  }, [isMobile, hasMore, loading, currentPage]);

  const board = boards.find(b => b.id === boardId);
  if (!board) return <div>Board not found</div>;
  const isAll = boardId === 'all';

  const renderThreadCard = (thread: Thread, boardName: string) => {
    if (hiddenThreads.has(thread.id)) {
      return (
        <div key={thread.id} className="bg-gray-50 p-3 rounded-sm border border-gray-200 flex justify-between items-center text-xs text-gray-500 shadow-sm">
          <span className="font-bold">{t('meta.hidden_thread')}: {thread.title.substring(0, 30)}...</span>
          <button onClick={(e) => onToggleHide(e, thread.id)} className="text-[#0056b3] hover:underline">[{t('meta.show')}]</button>
        </div>
      );
    }

    const d = new Date(thread.updatedAt);
    let dateStr;
    const isJa = i18n.language === 'ja-JP';

    if (isJa) {
      const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const day = days[d.getDay()];
      let y = d.getFullYear().toString();
      if (d.getFullYear() >= 2019) y = 'R' + (d.getFullYear() - 2018);
      else if (d.getFullYear() >= 1989) y = 'H' + (d.getFullYear() - 1988);
      else if (d.getFullYear() >= 1926) y = 'S' + (d.getFullYear() - 1925);
      dateStr = `${y}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}(${day}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}.00`;
    } else {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dateStr = `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}(${days[d.getDay()]}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}.00`;
    }

    const isFollowed = followedThreads.has(thread.id);

    return (
      <div key={thread.id} className="bg-white p-5 rounded-sm shadow-sm border border-gray-200 relative group">
        <div className="absolute top-4 right-4 text-xs text-gray-400">
          {dateStr} <span className="ml-2">ID:{thread.opPost.uid}</span>
          <button onClick={(e) => onToggleHide(e, thread.id)} className="ml-2 text-[#0056b3] hover:underline">[{t('meta.hide')}]</button>
        </div>
        <div className="mt-1">
          <div className="mb-2 pr-40">
            <span
              className="text-lg font-bold text-[#333] cursor-pointer hover:underline hover:text-[#0056b3]"
              onClick={() => onThreadClick(thread)}
            >
              {thread.title}
            </span>
          </div>
          <div
            className="text-sm text-[#333] leading-relaxed mb-3 cursor-pointer"
            onClick={() => onThreadClick(thread)}
          >
            {thread.opPost.content.length > 200 ? thread.opPost.content.substring(0, 200) + '...' : thread.opPost.content}
          </div>
          <div className="mb-3">
            <a className="text-[#0056b3] text-sm break-all hover:underline" href={`/board/${thread.boardId}/thread/${thread.id}`}>
              https://7ch-web.vercel.app/board/{thread.boardId}/thread/{thread.id}/
            </a>
          </div>
          <div className="flex items-center gap-4 text-xs font-bold text-gray-600">
            <div className="flex items-center gap-1 text-[#0056b3]">
              <span>ğŸ’¬</span>
              <span>{thread.postCount}</span>
            </div>
            <div className="text-[#0056b3]">{boardName}</div>
            <div className="flex items-center gap-1">
              <span>âš¡</span>
              <span>{thread.viewCount}</span>
            </div>
            <button
              onClick={(e) => onToggleFollow(e, thread.id)}
              className={`px-3 py-1 rounded text-xs transition-colors ml-auto border ${isFollowed ? 'bg-white text-[#2da0b3] border-[#2da0b3]' : 'bg-[#2da0b3] text-white border-[#2da0b3] hover:bg-[#238a9b]'}`}
            >
              {isFollowed ? t('meta.following') : t('meta.follow')}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // ä»…åœ¨æœ‰æœç´¢è¯æ—¶è¿›è¡Œå‰ç«¯è¿‡æ»¤ï¼ˆæ ‡é¢˜ + OP å†…å®¹ï¼‰ã€‚
  // Client-side filter when search term exists (title + OP content).
  const filteredThreads = search.trim() ? threads.filter((thread) => {
    const s = search.trim().toLowerCase();
    const text = `${thread.title} ${thread.opPost.content}`.toLowerCase();
    return text.includes(s);
  }) : threads;

  return (
    <div className="bg-[#f0f0f0] min-h-[calc(100vh-3.5rem)]">
      <div className="max-w-4xl mx-auto py-6 px-2 sm:px-4">
        {!isAll && (
          <div className="mb-6 flex justify-center">
            {!showPostForm ? (
              <button
                onClick={() => setShowPostForm(true)}
                className="bg-white px-6 py-3 rounded shadow-sm border border-gray-300 text-[#333] font-bold hover:bg-gray-50 flex items-center gap-2 transition-colors"
              >
                <span className="text-xl text-[#2da0b3]">âœï¸</span>
                {t('thread.new')}
              </button>
            ) : (
              <PostForm
                boardId={boardId!}
                onSubmit={async (payload: any) => {
                  const newId = await api.createThread(payload);
                  const data = await api.getThreads(boardId!, 1);
                  setThreads(data.threads);
                  setTotal(data.total);
                  setTotalPages(data.totalPages);
                  setCurrentPage(1);
                  const newThread = data.threads.find(t => t.id === newId);
                  if (newThread) onThreadClick(newThread);
                }}
                onCancel={() => setShowPostForm(false)}
              />
            )}
          </div>
        )}

        <div className="space-y-4">
          {filteredThreads.map((thread) => {
            const bObj = boards.find(b => b.id === thread.boardId);
            const displayBoardName = isAll ? (bObj ? t(bObj.name) : thread.boardId) : t(board.name);
            return renderThreadCard(thread, displayBoardName);
          })}
        </div>

        {/* PC Mode: Classic Pagination */}
        {!isMobile && !search.trim() && (
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            onPageChange={handlePageChange}
          />
        )}

        {/* Mobile Mode: Infinite Scroll Trigger */}
        {isMobile && !search.trim() && (
          <div ref={loadMoreRef} className="py-4 text-center">
            {loading && <span className="text-gray-500">{t('meta.loading')}...</span>}
            {!loading && hasMore && (
              <button
                onClick={() => {
                  const nextPage = currentPage + 1;
                  setCurrentPage(nextPage);
                  loadThreads(nextPage, true);
                }}
                className="text-[#0056b3] hover:underline"
              >
                {t('pagination.load_more')}
              </button>
            )}
            {!hasMore && threads.length > 0 && (
              <div className="text-gray-500">{t('pagination.no_more')}</div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// --- Favorites View Component ---
// æ”¶è—é¡µï¼šé€šè¿‡çº¿ç¨‹è¯¦æƒ…æ¥å£å›å¡«æœ€æ–°å†…å®¹ã€‚
// Favorites view: hydrates latest data via thread detail API.
const FavoritesView: React.FC<{
  followedThreads: Set<string>;
  boards: Board[];
  onThreadClick: (thread: Thread) => void;
  onToggleHide: (e: React.MouseEvent, id: string) => void;
  onToggleFollow: (e: React.MouseEvent, id: string) => void;
  hiddenThreads: Set<string>;
}> = ({ followedThreads, boards, onThreadClick, onToggleHide, onToggleFollow, hiddenThreads }) => {
  const { t, i18n } = useTranslation();
  const [favThreads, setFavThreads] = useState<Thread[]>([]);
  const [loadingFavs, setLoadingFavs] = useState(false);

  useEffect(() => {
    const loadFavoriteThreads = async () => {
      setLoadingFavs(true);
      try {
        const ids = Array.from(followedThreads);
        const results = await Promise.all(
          ids.map(id => api.getThreadContent(id).catch(() => null))
        );
        const validThreads = results.filter((t): t is Thread => t !== null);
        validThreads.sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
        setFavThreads(validThreads);
      } finally {
        setLoadingFavs(false);
      }
    };
    loadFavoriteThreads();
  }, [followedThreads.size]);

  const renderThreadCard = (thread: Thread, boardName: string) => {
    if (hiddenThreads.has(thread.id)) {
      return (
        <div key={thread.id} className="bg-gray-50 p-3 rounded-sm border border-gray-200 flex justify-between items-center text-xs text-gray-500 shadow-sm">
          <span className="font-bold">{t('meta.hidden_thread')}: {thread.title.substring(0, 30)}...</span>
          <button onClick={(e) => onToggleHide(e, thread.id)} className="text-[#0056b3] hover:underline">[{t('meta.show')}]</button>
        </div>
      );
    }

    const d = new Date(thread.updatedAt);
    let dateStr;
    const isJa = i18n.language === 'ja-JP';

    if (isJa) {
      const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const day = days[d.getDay()];
      let y = d.getFullYear().toString();
      if (d.getFullYear() >= 2019) y = 'R' + (d.getFullYear() - 2018);
      else if (d.getFullYear() >= 1989) y = 'H' + (d.getFullYear() - 1988);
      else if (d.getFullYear() >= 1926) y = 'S' + (d.getFullYear() - 1925);
      dateStr = `${y}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}(${day}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}.00`;
    } else {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dateStr = `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}(${days[d.getDay()]}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}.00`;
    }

    const isFollowed = followedThreads.has(thread.id);

    return (
      <div key={thread.id} className="bg-white p-5 rounded-sm shadow-sm border border-gray-200 relative group">
        <div className="absolute top-4 right-4 text-xs text-gray-400">
          {dateStr} <span className="ml-2">ID:{thread.opPost.uid}</span>
          <button onClick={(e) => onToggleHide(e, thread.id)} className="ml-2 text-[#0056b3] hover:underline">[{t('meta.hide')}]</button>
        </div>
        <div className="mt-1">
          <div className="mb-2 pr-40">
            <span
              className="text-lg font-bold text-[#333] cursor-pointer hover:underline hover:text-[#0056b3]"
              onClick={() => onThreadClick(thread)}
            >
              {thread.title}
            </span>
          </div>
          <div
            className="text-sm text-[#333] leading-relaxed mb-3 cursor-pointer"
            onClick={() => onThreadClick(thread)}
          >
            {thread.opPost.content.length > 200 ? thread.opPost.content.substring(0, 200) + '...' : thread.opPost.content}
          </div>
          <div className="mb-3">
            <a className="text-[#0056b3] text-sm break-all hover:underline" href={`/board/${thread.boardId}/thread/${thread.id}`}>
              https://7ch-web.vercel.app/board/{thread.boardId}/thread/{thread.id}/
            </a>
          </div>
          <div className="flex items-center gap-4 text-xs font-bold text-gray-600">
            <div className="flex items-center gap-1 text-[#0056b3]">
              <span>ğŸ’¬</span>
              <span>{thread.postCount}</span>
            </div>
            <div className="text-[#0056b3]">{boardName}</div>
            <div className="flex items-center gap-1">
              <span>âš¡</span>
              <span>{thread.viewCount}</span>
            </div>
            <button
              onClick={(e) => onToggleFollow(e, thread.id)}
              className={`px-3 py-1 rounded text-xs transition-colors ml-auto border ${isFollowed ? 'bg-white text-[#2da0b3] border-[#2da0b3]' : 'bg-[#2da0b3] text-white border-[#2da0b3] hover:bg-[#238a9b]'}`}
            >
              {isFollowed ? t('meta.following') : t('meta.follow')}
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="bg-[#f0f0f0] min-h-[calc(100vh-3.5rem)]">
      <div className="max-w-4xl mx-auto py-6 px-2 sm:px-4">
        <div className="mb-4 text-xl font-bold text-gray-700 flex items-center gap-2">
          <span>â˜…</span> {t('nav.favorites')}
        </div>
        {loadingFavs ? (
          <div className="text-center text-gray-500 py-10">{t('meta.loading')}</div>
        ) : favThreads.length === 0 ? (
          <div className="bg-white p-10 text-center text-gray-500 rounded border border-gray-200">
            {t('meta.no_favorites')}
          </div>
        ) : (
          <div className="space-y-4">
            {favThreads.map(thread => {
              if (!followedThreads.has(thread.id)) return null;
              const boardObj = boards.find(b => b.id === thread.boardId);
              const boardName = boardObj ? t(boardObj.name) : thread.boardId;
              return renderThreadCard(thread, boardName);
            })}
          </div>
        )}
      </div>
    </div>
  );
};

// --- Thread View Wrapper Component ---
// è·¯ç”±åŒ…è£…å±‚ï¼šè¯»å– URL å‚æ•°å¹¶æ³¨å…¥ ThreadViewã€‚
// Route wrapper: reads URL params and injects ThreadView props.
const ThreadViewWrapper: React.FC<{
  followedThreads: Set<string>;
  onToggleFollow: (e: any, id: string) => void;
  refreshToken: number;
  enablePolling: boolean;
}> = ({ followedThreads, onToggleFollow, refreshToken, enablePolling }) => {
  const { boardId, threadId } = useParams();
  const navigate = useNavigate();

  if (!boardId || !threadId) return <div>Invalid thread</div>;

  return (
    <div className="bg-[#f0f0f0] min-h-[calc(100vh-3.5rem)] pt-4">
      <ThreadView
        threadId={threadId}
        onBack={() => navigate(`/board/${boardId}`)}
        isFollowed={followedThreads.has(threadId)}
        onToggleFollow={(e) => onToggleFollow(e, threadId)}
        refreshToken={refreshToken}
        enablePolling={enablePolling}
      />
    </div>
  );
};

// --- Main App Component ---
// å…¨å±€çŠ¶æ€ + SSE æ¨é€ + é¡µé¢å¯¼èˆªã€‚
// Global state + SSE updates + navigation.
const App: React.FC = () => {
  const { t, i18n } = useTranslation();
  const navigate = useNavigate();
  const location = useLocation();
  const [boards, setBoards] = useState<Board[]>([]);
  const [boardsError, setBoardsError] = useState<string | null>(null);

  const [boardRefreshToken, setBoardRefreshToken] = useState(0);
  const [threadRefreshToken, setThreadRefreshToken] = useState(0);
  const [showBoardUpdateNotice, setShowBoardUpdateNotice] = useState(false);
  const [showThreadUpdateNotice, setShowThreadUpdateNotice] = useState(false);
  const [showVersionUpdateNotice, setShowVersionUpdateNotice] = useState(false);
  const [latestServerVersion, setLatestServerVersion] = useState<string | null>(null);
  const [sseConnected, setSseConnected] = useState(false);

  const [search, setSearch] = useState<string>('');
  const searchInputRef = useRef<HTMLInputElement>(null);

  const threadMatch = location.pathname.match(/^\/board\/([^/]+)\/thread\/([^/]+)\/?$/);
  const boardMatch = location.pathname.match(/^\/board\/([^/]+)\/?$/);
  const currentBoardId = threadMatch?.[1] ?? boardMatch?.[1] ?? null;
  const currentThreadId = threadMatch?.[2] ?? null;
  const isThreadPage = Boolean(threadMatch);
  const isBoardPage = Boolean(boardMatch) && !isThreadPage;

  const routeRef = useRef({
    currentBoardId: null as string | null,
    currentThreadId: null as string | null,
    isThreadPage: false,
    isBoardPage: false,
  });

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Cmd+K or Ctrl+K or / (if not in input)
      if ((e.key === 'k' && (e.metaKey || e.ctrlKey)) || (e.key === '/' && !['INPUT', 'TEXTAREA'].includes((e.target as HTMLElement).tagName))) {
        e.preventDefault();
        searchInputRef.current?.focus();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  useEffect(() => {
    routeRef.current = {
      currentBoardId,
      currentThreadId,
      isThreadPage,
      isBoardPage,
    };
  }, [currentBoardId, currentThreadId, isThreadPage, isBoardPage]);

  useEffect(() => {
    setShowBoardUpdateNotice(false);
    setShowThreadUpdateNotice(false);
  }, [location.pathname]);

  useEffect(() => {
    if (isMockMode) return;

    // SSEï¼šè®¢é˜…æœåŠ¡ç«¯äº‹ä»¶ï¼Œç”¨äºæ–°å¸–ã€æ–°å›å¤ä¸ç‰ˆæœ¬æ›´æ–°æç¤ºã€‚
    // SSE: subscribe to server events for new content and version notices.
    const es = new EventSource(`${apiBaseUrl}/api/events`);
    const parseData = (e: MessageEvent) => {
      if (!e.data) return null;
      try {
        return JSON.parse(e.data);
      } catch {
        return null;
      }
    };

    const handleServerVersion = (e: MessageEvent) => {
      const payload = parseData(e);
      const version = payload?.version ?? e.data;
      if (!version) return;

      const stored = localStorage.getItem('7ch_server_version');
      if (!stored) {
        localStorage.setItem('7ch_server_version', version);
        return;
      }
      if (stored !== version) {
        setLatestServerVersion(version);
        setShowVersionUpdateNotice(true);
      }
    };

    const handleThreadCreated = (e: MessageEvent) => {
      const payload = parseData(e);
      if (!payload) return;
      const { boardId } = payload as { boardId?: string };
      const { currentBoardId, isBoardPage } = routeRef.current;
      if (!isBoardPage || !currentBoardId || !boardId) return;
      if (currentBoardId === 'all' || currentBoardId === boardId) {
        setShowBoardUpdateNotice(true);
      }
    };

    const handlePostCreated = (e: MessageEvent) => {
      const payload = parseData(e);
      if (!payload) return;
      const { threadId, boardId } = payload as { threadId?: string; boardId?: string };
      const { currentThreadId, currentBoardId, isThreadPage, isBoardPage } = routeRef.current;
      if (isThreadPage && currentThreadId && threadId === currentThreadId) {
        setShowThreadUpdateNotice(true);
        return;
      }
      if (!isBoardPage || !currentBoardId || !boardId) return;
      if (currentBoardId === 'all' || currentBoardId === boardId) {
        setShowBoardUpdateNotice(true);
      }
    };

    const handleResync = () => {
      const { isThreadPage, isBoardPage } = routeRef.current;
      if (isThreadPage) setShowThreadUpdateNotice(true);
      if (isBoardPage) setShowBoardUpdateNotice(true);
    };

    es.addEventListener('server_version', handleServerVersion as EventListener);
    es.addEventListener('thread_created', handleThreadCreated as EventListener);
    es.addEventListener('post_created', handlePostCreated as EventListener);
    es.addEventListener('resync', handleResync as EventListener);
    es.onopen = () => setSseConnected(true);
    es.onerror = () => setSseConnected(false);

    return () => {
      es.removeEventListener('server_version', handleServerVersion as EventListener);
      es.removeEventListener('thread_created', handleThreadCreated as EventListener);
      es.removeEventListener('post_created', handlePostCreated as EventListener);
      es.removeEventListener('resync', handleResync as EventListener);
      es.close();
    };
  }, []);

  // éšè—çº¿ç¨‹ï¼ˆæŒä¹…åŒ–åˆ° LocalStorageï¼‰ã€‚
  // Hidden threads (persisted in LocalStorage).
  const [hiddenThreads, setHiddenThreads] = useState<Set<string>>(() => {
    try {
      const saved = localStorage.getItem('7ch_hidden_threads');
      return saved ? new Set(JSON.parse(saved)) : new Set();
    } catch {
      return new Set();
    }
  });

  // å…³æ³¨çº¿ç¨‹ï¼ˆæŒä¹…åŒ–åˆ° LocalStorageï¼‰ã€‚
  // Followed threads (persisted in LocalStorage).
  const [followedThreads, setFollowedThreads] = useState<Set<string>>(() => {
    try {
      const saved = localStorage.getItem('7ch_followed_threads');
      return saved ? new Set(JSON.parse(saved)) : new Set();
    } catch {
      return new Set();
    }
  });

  // å¼¹çª—ä¸ç§»åŠ¨ç«¯ UI çŠ¶æ€ã€‚
  // Modal and mobile UI state.
  const [showDonateModal, setShowDonateModal] = useState(false);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const [showMobileLoginDialog, setShowMobileLoginDialog] = useState(false);

  useEffect(() => {
    api.getBoards()
      .then(setBoards)
      .catch((e: any) => {
        setBoardsError(String(e?.message ?? e) || 'åŠ è½½å¤±è´¥');
        setBoards([
          { id: 'all', name: 'board.all.name', description: 'board.all.desc' },
          { id: 'news', name: 'board.news.name', description: 'board.news.desc' },
          { id: 'g', name: 'board.g.name', description: 'board.g.desc' },
          { id: 'acg', name: 'board.acg.name', description: 'board.acg.desc' },
          { id: 'vip', name: 'board.vip.name', description: 'board.vip.desc' },
        ]);
      });
  }, []);

  const changeLang = (lng: string) => {
    // è¯­è¨€åˆ‡æ¢ï¼šåŒæ—¶è½åœ° localStorageï¼Œä¿æŒåˆ·æ–°åè¯­è¨€ä¸€è‡´ã€‚
    // Language switch: persist to localStorage for reload consistency.
    i18n.changeLanguage(lng);
    localStorage.setItem('7ch_lang', lng);
  };

  const toggleHide = (e: React.MouseEvent, id: string) => {
    e.stopPropagation();
    setHiddenThreads(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      localStorage.setItem('7ch_hidden_threads', JSON.stringify(Array.from(next)));
      return next;
    });
  };

  const toggleFollow = (e: React.MouseEvent | null, id: string) => {
    if (e) e.stopPropagation();
    setFollowedThreads(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      localStorage.setItem('7ch_followed_threads', JSON.stringify(Array.from(next)));
      return next;
    });
  };

  const handleBoardRefresh = () => {
    setShowBoardUpdateNotice(false);
    setBoardRefreshToken(t => t + 1);
  };

  const handleThreadRefresh = () => {
    setShowThreadUpdateNotice(false);
    setThreadRefreshToken(t => t + 1);
  };

  const handleVersionRefresh = () => {
    // è®°å½•æœ€æ–°ç‰ˆæœ¬å¹¶å¼ºåˆ¶åˆ·æ–°é¡µé¢ã€‚
    // Store latest version then hard reload.
    if (latestServerVersion) {
      localStorage.setItem('7ch_server_version', latestServerVersion);
    }
    window.location.reload();
  };

  const handleVersionDismiss = () => {
    if (latestServerVersion) {
      localStorage.setItem('7ch_server_version', latestServerVersion);
    }
    setShowVersionUpdateNotice(false);
  };

  const handleThreadClick = (thread: Thread) => {
    navigate(`/board/${thread.boardId}/thread/${thread.id}`);
  };

  // --- Render Functions ---
  // è§†å›¾æ‹†åˆ†ä¸ºå‡½æ•°ï¼Œä¾¿äºé˜…è¯»ä¸å¤ç”¨ã€‚
  // Split rendering into functions for clarity.

  const renderHeader = () => (
    <header className="bg-white border-b border-gray-200 sticky top-0 z-20">
      <div className="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
        <div className="flex items-center cursor-pointer" onClick={() => navigate('/')}>
          <span className="text-xl sm:text-2xl font-bold text-gray-600 font-serif tracking-tight">7ã¡ã‚ƒã‚“ã­ã‚‹</span>
        </div>
        <div className="flex items-center gap-4">
          <div className="hidden md:flex items-center relative">
            <input
              ref={searchInputRef}
              type="text"
              placeholder={t('board.catalog')}
              className="bg-gray-100 border border-gray-300 rounded px-3 py-1 text-sm w-48 focus:outline-none focus:border-gray-400 pr-8 transition-colors"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
            <div className="absolute right-2 flex items-center gap-1 pointer-events-none">
              <kbd className="hidden sm:inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100 bg-gray-200 text-gray-500 border-gray-300">
                <span className="text-xs">âŒ˜</span>K
              </kbd>
              <Search className="text-gray-400 w-4 h-4" />
            </div>
          </div>
          {/* Desktop navigation - hidden on mobile */}
          <div className="hidden md:flex items-center gap-3 text-sm text-[#0056b3] font-medium">
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button variant="outline">{t('dialog.login.button')}</Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>{t('dialog.login.title')}</AlertDialogTitle>
                  <AlertDialogDescription>
                    {t('dialog.login.description')}
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>{t('dialog.login.close')}</AlertDialogCancel>
                  <Link to="/docs">
                    <AlertDialogAction>{t('dialog.login.link_text')}</AlertDialogAction>
                  </Link>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
            <button className="hover:underline" onClick={() => navigate('/')}>{t('nav.boards')}</button>
            <button
              className="hover:underline"
              onClick={() => navigate('/favorites')}
            >
              {t('nav.favorites')}
            </button>
            <div className="border-l border-gray-300 pl-3 flex gap-2">
              {['zh-CN', 'ja-JP'].map(l => (
                <button
                  key={l}
                  onClick={() => changeLang(l)}
                  className={`text-xs ${i18n.language === l ? 'font-bold text-black' : 'text-gray-400'}`}
                >
                  {l === 'zh-CN' ? 'ä¸­æ–‡' : 'æ—¥'}
                </button>
              ))}
            </div>
          </div>
          {/* Mobile dropdown menu */}
          <div className="md:hidden relative">
            <button
              className="text-[#0056b3] text-sm font-medium p-2"
              onClick={() => setShowMobileMenu(!showMobileMenu)}
            >
              â˜°
            </button>
            {showMobileMenu && (
              <div className="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded shadow-lg z-50">
                <div className="py-1">
                  <button
                    className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm"
                    onClick={() => setShowMobileLoginDialog(true)}
                  >
                    {t('dialog.login.button')}
                  </button>
                  <button
                    className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm border-t border-gray-200"
                    onClick={() => {
                      navigate('/');
                      setShowMobileMenu(false);
                    }}
                  >
                    {t('nav.boards')}
                  </button>
                  <button
                    className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm"
                    onClick={() => {
                      navigate('/favorites');
                      setShowMobileMenu(false);
                    }}
                  >
                    {t('nav.favorites')}
                  </button>
                  <div className="border-t border-gray-200 pt-1">
                    {['zh-CN', 'ja-JP'].map(l => (
                      <button
                        key={l}
                        onClick={() => {
                          changeLang(l);
                          setShowMobileMenu(false);
                        }}
                        className={`block w-full text-left px-4 py-2 text-sm ${i18n.language === l ? 'font-bold text-black' : 'text-gray-400'}`}
                      >
                        {l === 'zh-CN' ? 'ä¸­æ–‡' : 'æ—¥'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
  );

  const renderLiveNotices = () => (
    <>
      {showVersionUpdateNotice && (
        <div className="bg-amber-50 border-b border-amber-200 text-amber-900">
          <div className="max-w-7xl mx-auto px-4 py-2 flex flex-wrap items-center gap-3 text-sm">
            <span className="font-bold">{t('realtime.new_version')}</span>
            <div className="ml-auto flex items-center gap-2">
              <button
                onClick={handleVersionRefresh}
                className="px-3 py-1 rounded border border-amber-300 text-amber-900 bg-amber-100 hover:bg-amber-200 transition-colors"
              >
                {t('realtime.refresh_page')}
              </button>
              <button
                onClick={handleVersionDismiss}
                className="px-3 py-1 rounded border border-amber-200 text-amber-700 hover:bg-amber-100 transition-colors"
              >
                {t('realtime.dismiss')}
              </button>
            </div>
          </div>
        </div>
      )}
      {showThreadUpdateNotice && (
        <div className="bg-sky-50 border-b border-sky-200 text-sky-900">
          <div className="max-w-7xl mx-auto px-4 py-2 flex flex-wrap items-center gap-3 text-sm">
            <span className="font-bold">{t('realtime.new_replies')}</span>
            <div className="ml-auto flex items-center gap-2">
              <button
                onClick={handleThreadRefresh}
                className="px-3 py-1 rounded border border-sky-300 text-sky-900 bg-sky-100 hover:bg-sky-200 transition-colors"
              >
                {t('realtime.load_replies')}
              </button>
              <button
                onClick={() => setShowThreadUpdateNotice(false)}
                className="px-3 py-1 rounded border border-sky-200 text-sky-700 hover:bg-sky-100 transition-colors"
              >
                {t('realtime.dismiss')}
              </button>
            </div>
          </div>
        </div>
      )}
      {showBoardUpdateNotice && (
        <div className="bg-blue-50 border-b border-blue-200 text-blue-900">
          <div className="max-w-7xl mx-auto px-4 py-2 flex flex-wrap items-center gap-3 text-sm">
            <span className="font-bold">{t('realtime.new_content')}</span>
            <div className="ml-auto flex items-center gap-2">
              <button
                onClick={handleBoardRefresh}
                className="px-3 py-1 rounded border border-blue-300 text-blue-900 bg-blue-100 hover:bg-blue-200 transition-colors"
              >
                {t('realtime.refresh_list')}
              </button>
              <button
                onClick={() => setShowBoardUpdateNotice(false)}
                className="px-3 py-1 rounded border border-blue-200 text-blue-700 hover:bg-blue-100 transition-colors"
              >
                {t('realtime.dismiss')}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );

  const renderFooter = () => (
    <footer className="mt-auto py-8 text-center text-sm text-gray-500 border-t border-gray-200 bg-white">
      <div className="flex justify-center flex-wrap gap-4 sm:gap-6 mb-4">
        <Link to="/privacy"><button className="text-gray-500 hover:underline hover:text-[#0056b3]">{t('footer.privacy')}</button></Link>
        <Link to="/docs"><button className="text-gray-500 hover:underline hover:text-[#0056b3]">{t('footer.tech')}</button></Link>
        <Link to="/terms"><button className="text-gray-500 hover:underline hover:text-[#0056b3]">{t('footer.terms')}</button></Link>
        <Link to="/help"><button className="text-gray-500 hover:underline hover:text-[#0056b3]">{t('footer.help')}</button></Link>
        <Link to="/QA"><button className="text-gray-500 hover:underline hover:text-[#0056b3]">{t('footer.QA')}</button></Link>
        <Link to="/changelog"><button className="text-gray-500 hover:underline hover:text-[#0056b3]">Changelog</button></Link>
        <button className="text-gray-500 hover:underline hover:text-[#0056b3]" onClick={() => setShowDonateModal(true)}>{t('footer.donate')}</button>
      </div>
      <div>&copy; 2024 7ch Project. All rights reserved.</div>
    </footer>
  );

  return (
    <div className="min-h-screen font-sans bg-[#ffffff] text-[#333] flex flex-col">
      {renderHeader()}
      {renderLiveNotices()}
      {/* Mobile Login Dialog - rendered outside main content to ensure proper layering */}
      {showMobileLoginDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 md:hidden">
          <div className="bg-white rounded p-6 max-w-sm w-full max-h-[80vh] overflow-y-auto">
            <h3 className="font-bold text-lg mb-2">{t('dialog.login.title')}</h3>
            <p className="text-sm mb-4">{t('dialog.login.description')}</p>
            <div className="flex justify-end gap-2">
              <button
                className="px-4 py-2 border border-gray-300 rounded text-sm"
                onClick={() => setShowMobileLoginDialog(false)}
              >
                {t('dialog.login.close')}
              </button>
              <Link to="/docs" onClick={() => setShowMobileLoginDialog(false)}>
                <button className="px-4 py-2 bg-[#0056b3] text-white rounded text-sm">
                  {t('dialog.login.link_text')}
                </button>
              </Link>
            </div>
          </div>
        </div>
      )}
      <main className="flex-1">
        <Routes>
          {/* é¦–é¡µ - çœ‹æ¿åˆ—è¡¨ */}
          <Route path="/" element={
            <div className="p-4 max-w-4xl mx-auto mt-4">
              <div className="bg-white p-6 border border-gray-200 rounded-sm shadow-sm">
                <h2 className="text-xl font-bold mb-6 text-gray-800 border-b pb-2">{t('nav.boards')}</h2>
                {boardsError && (
                  <div className="mb-4 p-3 rounded border border-red-200 bg-red-100 text-red-700">
                    {t('meta.loading')}: {boardsError}
                  </div>
                )}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {(search.trim() ? boards.filter(b => {
                    const s = search.trim().toLowerCase();
                    const name = `${b.id} ${t(b.name)} ${t(b.description)}`.toLowerCase();
                    return name.includes(s);
                  }) : boards).map(b => (
                    <div
                      key={b.id}
                      onClick={() => navigate(`/board/${b.id}`)}
                      className="p-4 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer transition-colors"
                    >
                      <div className="font-bold text-[#0056b3] text-lg mb-1">/{b.id}/ - {t(b.name)}</div>
                      <div className="text-sm text-gray-500">{t(b.description)}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          } />

          {/* çœ‹æ¿è¯¦æƒ…é¡µ */}
          <Route path="/board/:boardId" element={
            <BoardView
              boards={boards}
              search={search}
              onCreateThread={async (payload: any) => {
                // Handled inside BoardView component
              }}
              onThreadClick={handleThreadClick}
              onToggleHide={toggleHide}
              onToggleFollow={toggleFollow}
              hiddenThreads={hiddenThreads}
              followedThreads={followedThreads}
              refreshToken={boardRefreshToken}
            />
          } />

          {/* å¸–å­è¯¦æƒ…é¡µ */}
          <Route path="/board/:boardId/thread/:threadId" element={
            <ThreadViewWrapper
              followedThreads={followedThreads}
              onToggleFollow={toggleFollow}
              refreshToken={threadRefreshToken}
              enablePolling={!sseConnected}
            />
          } />

          {/* æ”¶è—å¤¹ */}
          <Route path="/favorites" element={
            <FavoritesView
              followedThreads={followedThreads}
              boards={boards}
              onThreadClick={handleThreadClick}
              onToggleHide={toggleHide}
              onToggleFollow={toggleFollow}
              hiddenThreads={hiddenThreads}
            />
          } />

          {/* æ–‡æ¡£é¡µé¢ */}
          <Route path="/docs" element={<Docs onBack={() => navigate('/')} />} />
          <Route path="/privacy" element={<PrivacyPolicy onBack={() => navigate('/')} />} />
          <Route path="/terms" element={<Terms onBack={() => navigate('/')} />} />
          <Route path="/help" element={<Help onBack={() => navigate('/')} />} />
          <Route path="/QA" element={<QA onBack={() => navigate('/')} />} />
          <Route path="/changelog" element={<Changelog onBack={() => navigate('/')} />} />
        </Routes>
      </main>
      {renderFooter()}
      <DonateModal open={showDonateModal} onClose={() => setShowDonateModal(false)} />
    </div>
  );
};

export default App;
